#!/bin/bash

set -eu

datadir=/var/vcap/data/http
docroot=$datadir/docroot-<%= p('docroot_version') %>

if [ -e $docroot/version ] ; then
  exit
fi

mkdir -p $docroot
chown vcap:vcap $docroot

find /var/vcap/data/http -maxdepth 1 -name 'docroot-*' | grep -v "$docroot" | xargs rm -fr

wget -qO- https://<%= p('s3_bucket') %>.s3.amazonaws.com/docroot/<%= p('docroot_version') %>.tgz \
  | tar -xzf- -C "$docroot" --strip-components=1

echo "<%= p('docroot_version') %>" > $docroot/version
